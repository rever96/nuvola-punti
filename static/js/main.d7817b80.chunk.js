(this["webpackJsonppoint-cloud-annotator"]=this["webpackJsonppoint-cloud-annotator"]||[]).push([[0],{248:function(e,t,n){e.exports=n(505)},254:function(e,t,n){},505:function(e,t,n){"use strict";n.r(t);var a=n(0),o=n.n(a),i=n(8),r=n.n(i),s=(n(253),n(254),n(245)),l=n(41),c=n(55),d=n(49),u=n(48),m=n(3),p=n(225),h=n(226),f=n(227),w=n.n(f),v=function(){function e(){var t=this;Object(l.a)(this,e),this.loadPoints=function(e){return delete t.infoPoints,t.infoPoints={},new Promise((function(n,a){fetch("/nuvola-punti/assets/infopoints//"+e+".json").catch((function(e){return a(e)})).then((function(e){return e.json()})).then((function(e){t.infoPoints=e,n(t.infoPoints)}))}))},this.savePoints=function(e){if(t.infoPoints){if(window.navigator&&window.navigator.msSaveOrOpenBlob){var n=new Blob([decodeURIComponent(encodeURI(JSON.stringify(t.infoPoints)))],{type:"application/json;charset=utf-8;"});navigator.msSaveOrOpenBlob(n,e)}else{var a=document.createElement("a");a.download=e,a.href="data:application/json;charset=utf-8;,"+encodeURIComponent(JSON.stringify(t.infoPoints)),a.target="_blank",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}},this.addInfoPoint=function(e,n){var a={descrizione:e.descrizione,colore:e.colore||"#ffffff",point:n};return t.infoPoints[e.titolo]=a,a}}return Object(c.a)(e,null,[{key:"getInstance",value:function(){return null==e.myInstance&&(e.myInstance=new e),this.myInstance}}]),e}();v.myInstance=null;var g,y,b,C,E,x=v,k=n(512),P=n(511),S=n(514),j=n(58),O=n(228),M=function(e){Object(d.a)(n,e);var t=Object(u.a)(n);function n(){var e;Object(l.a)(this,n);for(var a=arguments.length,o=new Array(a),i=0;i<a;i++)o[i]=arguments[i];return(e=t.call.apply(t,[this].concat(o))).state={displayColorPicker:!1,background:"#fff"},e.handleClick=function(){e.setState({displayColorPicker:!e.state.displayColorPicker})},e.handleClose=function(){e.setState({displayColorPicker:!1})},e.handleChange=function(t){e.setState({background:t.hex})},e.handleChangeComplete=function(t){e.props.changeColor(t.hex),e.setState({background:t.hex})},e}return Object(c.a)(n,[{key:"render",value:function(){return o.a.createElement("div",null,o.a.createElement(j.a,{style:{backgroundColor:this.state.background},onClick:this.handleClick},!this.state.displayColorPicker&&"Apri ",this.state.displayColorPicker&&"Chiudi ","ColorPicker"),this.state.displayColorPicker?o.a.createElement("div",{style:{position:"absolute",zIndex:"2"}},o.a.createElement("div",{style:{position:"fixed",top:"0px",right:"0px",bottom:"0px",left:"0px"},onClick:this.handleClose}),o.a.createElement(O.ChromePicker,{color:this.state.background,onChange:this.handleChange,onChangeComplete:this.handleChangeComplete})):null)}}]),n}(o.a.Component),z={labelCol:{span:8},wrapperCol:{span:16}},I={wrapperCol:{offset:8,span:16}},F=function(e){Object(d.a)(n,e);var t=Object(u.a)(n);function n(){var e;Object(l.a)(this,n);for(var a=arguments.length,i=new Array(a),r=0;r<a;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))).formRef=o.a.createRef(),e.changeColor=function(t){e.formRef.current.setFieldsValue({colore:t})},e.onFinish=function(t){e.props.handleOk(t)},e.onFinishFailed=function(e){console.log("Failed:",e)},e}return Object(c.a)(n,[{key:"render",value:function(){return o.a.createElement("div",{onMouseMove:function(e){return e.stopPropagation()}},o.a.createElement(k.a,{title:"Basic Modal",visible:this.props.visible,footer:null,onCancel:this.props.handleCancel},this.props.visible&&o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,"x: ",this.props.point.x.toString().substring(0,5)),o.a.createElement(P.a,Object.assign({},z,{name:"basic",initialValues:{remember:!0},ref:this.formRef,onFinish:this.onFinish,onFinishFailed:this.onFinishFailed}),o.a.createElement(P.a.Item,{label:"Titolo*",name:"titolo",rules:[{required:!0,message:"Campo obbligatorio!"}]},o.a.createElement(S.a,null)),o.a.createElement(P.a.Item,{label:"Colore",name:"colore"},o.a.createElement(M,{changeColor:this.changeColor})),o.a.createElement(P.a.Item,{label:"Descrizione",name:"descrizione"},o.a.createElement(S.a.TextArea,null)),o.a.createElement(P.a.Item,I,o.a.createElement(j.a,{type:"primary",htmlType:"submit"},"Aggiungi"))))))}}]),n}(o.a.Component),R=n(513),W=n(507),U=n(508),A=n(509),B=n(510),D=n(515),T=n(516),H=R.a.Option,J=x.getInstance(),L=new m.s;L.params.Points.threshold=.01;var N,K=new m.x,V=new m.c,q=0,X=[],Y=new m.u(.04,32,32),_=new m.n({color:"#FF0000"}),G=new m.m(Y,_);G.scale.set(1,1,1);var Q=function(e){Object(d.a)(n,e);var t=Object(u.a)(n);function n(e){var a;return Object(l.a)(this,n),(a=t.call(this,e)).init=function(){w()(".alert-success").hide();var e=.75*window.innerWidth,t=.85*window.innerHeight;(b=new m.t).background=new m.d(32768),(C=new m.z({antialias:!0})).setPixelRatio(window.devicePixelRatio),C.setSize(e,t),C.dofAutofocus=!0,a.mount.appendChild(C.domElement),(g=new m.o(65,e/t,1,1e3)).position.set(8,4,8),g.up.set(0,1,0),a.setState({intrinsic:a.cameraMatrix2npString(g.projectionMatrix),extrinsic:a.cameraMatrix2npString(g.matrixWorldInverse)}),(y=new h.a(g,C.domElement)).enableDamping=!1,y.dampingFactor=.05,y.screenSpacePanning=!1,y.minDistance=1,y.maxDistance=500,y.maxPolarAngle=2*Math.PI,a.addPointcloud(),a.addSphereInfo();var n=new m.a(5);b.add(n),b.add(G)},a.cameraMatrix2npString=function(e){for(var t="np.array([",n=0;n<4;n++){t+="[";for(var a=0;a<4;a++){var o=4*n+a;t+=0===e.elements[o]?e.elements[o]:e.elements[o].toFixed(4),3!==a&&(t+=", ")}t+="]",3!==n&&(t+=", ")}return t+="])"},a.addPointcloud=function(){E=new m.p(new m.h,new m.l),(new p.a).load("/nuvola-punti/assets/pointclouds/"+a.state.frame+".pcd",(function(e){E=e,b.add(E),N=[E];var t=E.geometry.boundingSphere.radius;g.position.set(1.5*t,.5*t,1.5*t)}),(function(e){a.setState({loaded:Math.round(e.loaded/e.total*100)})}))},a.removePointcloud=function(){b.remove(E)},a.removeSphereKps=function(){X.forEach((function(e){var t=b.getObjectByProperty("uuid",e.uuid);t.geometry.dispose(),t.material.dispose(),b.remove(t)})),C.renderLists.dispose(),X=[]},a.addSphereInfo=function(){J.loadPoints(a.state.frame).catch((function(e){console.log(e)})).then((function(e){Object.keys(e).forEach((function(t){var n=g.position.distanceTo(e[t].point),a=new m.u(n/32,32,32),o=new m.n({color:e[t].colore}),i=new m.m(a,o);i.position.copy(e[t].point),X.push({uuid:i.uuid,titolo:t}),b.add(i)}))}))},a.animate=function(){a.setState({intrinsic:a.cameraMatrix2npString(g.projectionMatrix),extrinsic:a.cameraMatrix2npString(g.matrixWorldInverse)}),requestAnimationFrame(a.animate),y.update(),a.renderScene()},a.renderScene=function(){if(g.updateMatrixWorld(),L.setFromCamera(K,g),"undefined"!==typeof N){var e=L.intersectObjects(N),t=e.length>0?e[0]:null;q>.02&&null!=t&&(a.setState({point:t.point}),G.position.copy(t.point),q=0)}q+=V.getDelta(),C.render(b,g)},a.onMouseMove=function(e){e.preventDefault(),K.x=e.clientX/a.mount.clientWidth*2-1,K.y=-(e.clientY-.1*window.innerHeight)/a.mount.clientHeight*2+1},a.onMouseClick=function(e){e.shiftKey&&a.state.point.x&&a.showModal(a.state.point)},a.onWindowResize=function(){g.aspect=.75*window.innerWidth/(.85*window.innerHeight),g.updateProjectionMatrix(),C.setSize(.75*window.innerWidth,.85*window.innerHeight)},a.scaleDown=function(){var e=b.getObjectByName(a.state.frame+".pcd");e.material.size*=.8,e.material.needsUpdate=!0},a.scaleUp=function(){var e=b.getObjectByName(a.state.frame+".pcd");e.material.size*=1.2,e.material.needsUpdate=!0},a.onFrameUpdate=function(e){e!=a.state.frame&&(a.state.frame=e,a.removeSphereKps(),a.removePointcloud(),a.addPointcloud(),a.addSphereInfo())},a.showModal=function(e){a.setState({showModal:!0,selectedPoint:e})},a.handleOk=function(e){var t,n,o=J.addInfoPoint(e,a.state.selectedPoint),i=!1,r=Object(s.a)(X);try{for(r.s();!(n=r.n()).done;){var l=n.value;if(l.titolo===e.titolo){(t=b.getObjectByProperty("uuid",l.uuid)).position.copy(a.state.point),i=!0;break}}}catch(u){r.e(u)}finally{r.f()}if(!i){var c=new m.u(.04,32,32),d=new m.n({color:o.colore});(t=new m.m(c,d)).position.copy(o.point),X.push({uuid:t.uuid,titolo:e.titolo}),b.add(t)}a.setState({showModal:!1})},a.handleCancel=function(e){a.setState({showModal:!1})},a.state={showModal:!1,loaded:0,intrinsic:0,extrinsic:0,point:[],selectedPoint:[],impostazioniJson:null,frame:""},fetch("assets/impostazioni.json",{headers:{"Content-Type":"application/json",Accept:"application/json"}}).then((function(e){return e.json()})).then((function(e){a.setState({impostazioniJson:e,frame:e.filenames[0]}),a.init(),a.animate()})),a}return Object(c.a)(n,[{key:"componentDidMount",value:function(){window.addEventListener("resize",this.onWindowResize,!1),window.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("click",this.onMouseClick,!1)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("resize"),window.removeEventListener("mousemove"),window.removeEventListener("click")}},{key:"render",value:function(){var e=this;return o.a.createElement("div",null,o.a.createElement(F,{handleCancel:this.handleCancel,handleOk:this.handleOk,visible:this.state.showModal,point:this.state.selectedPoint}),o.a.createElement(W.a,{style:{height:"100vh",width:"100vw",backgroundColor:"#404040"}},o.a.createElement(U.a,{style:{width:.75*window.innerWidth}},o.a.createElement(W.a,{style:{height:.1*window.innerHeight}},o.a.createElement(j.a,{onClick:function(){return J.savePoints(e.state.frame)}},"Salva InfoPoint"),o.a.createElement(j.a,{onClick:this.scaleUp},o.a.createElement(D.a,null)),o.a.createElement(j.a,{onClick:this.scaleDown},o.a.createElement(T.a,null))),o.a.createElement(W.a,{style:{height:.85*window.innerHeight}},o.a.createElement("div",{ref:function(t){e.mount=t}})),o.a.createElement(W.a,{style:{height:.05*window.innerHeight}},o.a.createElement(A.a,{direction:"horizontal"},o.a.createElement(B.a.Text,{style:{color:"red"}},"x: ",this.state.point.x?this.state.point.x.toFixed(4):0),o.a.createElement(B.a.Text,{style:{color:"lime"}},"y: ",this.state.point.y?this.state.point.y.toFixed(4):0),o.a.createElement(B.a.Text,{style:{color:"blue"}},"z: ",this.state.point.z?this.state.point.z.toFixed(4):0)))),o.a.createElement(U.a,{flex:5},this.state.impostazioniJson&&o.a.createElement(W.a,null,o.a.createElement(A.a,{direction:"horizontal"},o.a.createElement(B.a.Text,{style:{color:"white",fontSize:"2em"}},"Nuvola:"),o.a.createElement(R.a,{defaultValue:this.state.frame,style:{width:120},onChange:this.onFrameUpdate},this.state.impostazioniJson.filenames.map((function(e,t){return o.a.createElement(H,{key:t,value:e},e)}))))))))}}]),n}(a.Component);r.a.render(o.a.createElement(Q,null),document.getElementById("root"))}},[[248,1,2]]]);
//# sourceMappingURL=main.d7817b80.chunk.js.map